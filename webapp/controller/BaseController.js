/*
 * Copyright (C) 2009-2023 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/ui/core/ValueState","scm/ewm/packoutbdlvs1/model/Global","scm/ewm/packoutbdlvs1/modelHelper/Global","scm/ewm/packoutbdlvs1/utils/Util","scm/ewm/packoutbdlvs1/modelHelper/SerialNumber","scm/ewm/packoutbdlvs1/modelHelper/Cache","scm/ewm/packoutbdlvs1/utils/Const","scm/ewm/packoutbdlvs1/model/PackingMode","scm/ewm/packoutbdlvs1/modelHelper/PackingMode","sap/ui/core/CustomData","sap/ushell/ui/footerbar/AddBookmarkButton","sap/suite/ui/commons/collaboration/ServiceContainer","sap/suite/ui/commons/collaboration/CollaborationHelper",'sap/ui/performance/trace/FESRHelper',"sap/ui/model/json/JSONModel","sap/fe/navigation/NavigationHandler","scm/ewm/packoutbdlvs1/model/Material","scm/ewm/packoutbdlvs1/modelHelper/Material","scm/ewm/packoutbdlvs1/model/AdvancedSourceTableSetting","scm/ewm/packoutbdlvs1/model/BasicSourceTableSetting","scm/ewm/packoutbdlvs1/model/InternalSourceTableSetting","scm/ewm/packoutbdlvs1/model/AdvancedShipTableSetting","scm/ewm/packoutbdlvs1/model/BasicShipTableSetting","scm/ewm/packoutbdlvs1/model/InternalShipTableSetting","scm/ewm/packoutbdlvs1/modelHelper/ItemWeight","scm/ewm/packoutbdlvs1/modelHelper/Message","scm/ewm/packoutbdlvs1/service/ODataService"],function(C,M,V,G,a,U,S,b,c,P,d,e,A,f,g,F,J,N,h,j,k,B,I,l,m,n,o,p,q){"use strict";var r="audio-player";var s="source-view";var t="ship-view";var u="main";var v="internal";var w="simple";var D="default";return C.extend("scm.ewm.packoutbdlvs1.controller.BaseController",{bCollaborationInitialized:false,onInit:function(){this.setModel(G,"global");this.setModel(this.getOwnerComponent().getModel("i18n"),"i18n");this.initModel();this.initWorkFlow();this.initErrorHandler();this.initSubscription();this.init();this.oPersonalizationService=this.getPersonalizationService();this.oNavigationHandler=new N(this);if(this.getView().getId().endsWith(u)||this.getView().getId().endsWith(v)||this.getView().getId().endsWith(w)){this.initShareFunctions();}var i=window.location.href;if(i.includes("sap-iapp-state")){this.initAppState();}this.getRouter().attachRouteMatched(function(E){var x=E.getParameters();if(x.name===this.sRouteName){if(U.isEmpty(a.getWarehouseNumber())||U.isEmpty(a.getPackStation())){if(this.sRouteName!==c.DEFAULT_ROUTE_NAME){this.getRouter().navTo("default",true);}}else{this.onRouteMatched(x.arguments);}if(x.name!==c.DEFAULT_ROUTE_NAME){this.publish(c.EVENT_BUS.CHANNELS.ROUTE_MATCHED,c.EVENT_BUS.EVENTS.SUCCESS);}}}.bind(this),this);},initShareFunctions:function(){this.oBookmarkButton=null;var R=sap.ui.getCore().getLibraryResourceBundle("sap.m");this.oShareActionSheet=this.byId("ShareButton");var i=new J({emailButtonText:R.getText("SEMANTIC_CONTROL_SEND_EMAIL"),bookmarkButtonText:R.getText("SEMANTIC_CONTROL_SAVE_AS_TILE"),bookmarkTitle:d.isInternalMode()?this.getI18nText("BOOKMARK_TITLE_PWS"):this.getI18nText("BOOKMARK_TITLE_POD"),bookmarkSubtitle:"",bookmarkIcon:d.isInternalMode()?"sap-icon://Fiori2/F3738":"sap-icon://Fiori2/F3193",bookmarkCustomUrl:function(){this.storeCurrentAppState();if(!window.hasher){sap.ui.require("sap/ui/thirdparty/hasher");}var H=window.hasher.getHash();return H?("#"+H):window.location.href;}.bind(this),bookmarkServiceUrl:function(){var x=d.isInternalMode()?'/sap/bc/ui5_ui5/ui2/ushell/shells/abap/FioriLaunchpad.html#EWMWorkCenter-packInternal?PackMode=2':'/sap/bc/ui5_ui5/ui2/ushell/shells/abap/FioriLaunchpad.html#EWMOutboundDelivery-packOutboundDelivery?PackMode=1';return x;}.bind(this),teamsTitle:d.isInternalMode()?this.getI18nText("TEAMS_TITLE_PWS"):this.getI18nText("TEAMS_TITLE_POD"),emailSubject:d.isInternalMode()?this.getI18nText("EMAIL_SUBJECT_PWS"):this.getI18nText("EMAIL_SUBJECT_POD")});g.isTeamsModeActive().then(function(x){i.setProperty('/isShareMenuButtonVisible',!x);}.bind(this));this.oInternalShareButton=this.byId("ShareButton-internalBtn");if(!U.isEmpty(this.oInternalShareButton)){this.oInternalShareButton.attachPress(function(){if(!this.bCollaborationInitialized){this.adjustShareMenu();}}.bind(this));}this.setModel(i,"share");},initModel:function(){},initWorkFlow:function(){},initErrorHandler:function(){},initSubscription:function(){},init:function(){},onRouteMatched:function(E){},oItemHelper:null,_updateInput:function(i,x,y,z){var E=i;if(typeof i==="string"){E=this.byId(i);}E.setValueState(x);E.setValueStateText(y);if(z!==undefined){E.setValue(z);}},onCancelDialog:function(E){E.getSource().getParent().close();this.setBusy(false);},updateInputWithDefault:function(i,x){this._updateInput(i,V.None,"",x);},updateInputWithWarning:function(i,W,x){this._updateInput(i,V.Warning,W,x);},updateInputWithSuccess:function(i,x){this._updateInput(i,V.Success,"",x);},updateInputWithError:function(i,E){var x="";if(U.isEmpty(E)){x=this.getI18nText("invalidEntry");}else{x=E;}this._updateInput(i,V.Error,x,"");},getI18nText:function(T,i){var x=this.getOwnerComponent().getModel("i18n");return x.getResourceBundle().getText(T,i);},setModel:function(i,x){this.getView().setModel(i,x);},getModel:function(i){return this.getOwnerComponent().getModel(i);},getGlobalModel:function(){return this.getView().getModel("global");},getSourceHU:function(){return this.getGlobalModel().getProperty("/sSourceHandlingUnit");},setSourceHU:function(i){this.getGlobalModel().setProperty("/sSourceHandlingUnit",i);},setInputEnable:function(i,E){var x=this.byId(i);x.setEnable(E);},focus:function(i){var x=i;if(typeof i==="string"){x=this.byId(i);}x.focus();return this;},getValue:function(i){var x=i;if(typeof i==="string"){x=this.byId(i);}return x.getValue();},getValueState:function(i){var x=i;if(typeof i==="string"){x=this.byId(i);}return x.getValueState();},displayInfoMessageBox:function(i){var x=!!this.getView().$().closest(".sapUiSizeCompact").length;M.information(i,{styleClass:x?"sapUiSizeCompact":""});this.playAudio(c.INFO);},showErrorMessageBox:function(i){var x=!!this.getView().$().closest(".sapUiSizeCompact").length;M.error(i,{styleClass:x?"sapUiSizeCompact":""});this.playAudio(c.ERROR);},setBusy:function(i){a.setBusy(!!i);},publish:function(i,E,x){this.getEventBus().publish(i,E,x);},subscribe:function(i,E,x){this.getEventBus().subscribe(i,E,x);},getEventBus:function(){return this.getOwnerComponent().getEventBus();},formatSerialIcon:function(i){var x="sap-icon://minimize";if(i){x="sap-icon://bullet-text";}return x;},formatEnableBtn:function(i){if(a.hasOpenShipHandlingUnit()){return true;}return false;},_mDialogPromise:null,openDialog:function(i){var x=this;if(this._mDialogPromise!==null){jQuery.sap.log.error("The prev closeDialog not called");}i.open();return new Promise(function(y,z){x._mDialogPromise={resolve:y,reject:z};});},cancelDialog:function(E){this.closeDialog(E.getSource().getParent(),c.ERRORS.INTERRUPT_WITH_NO_ACTION,true);this.setBusy(false);},closeDialog:function(i,x,R){if(this._mDialogPromise===null){jQuery.sap.log.error("openDialog/closeDialog must be pair worked");}i.close();if(R){this._mDialogPromise.reject(x);}else{this._mDialogPromise.resolve(x);}this._mDialogPromise=null;},openSerialNumberPopover:function(E,i,x){var y=E.getSource();var z=E.getSource().getBindingContext(i).getObject();var H=this.getView();var K=z.isIuidActive==c.ABAP_TRUE?true:false;var L=H.byId("serial-number-popover");var O=H.byId("serial-number-uii-popover");if(K){S.setSerialNumberUiisList(x.getItemSerialNumberUii(z));if(!O){O=sap.ui.xmlfragment(H.getId(),"scm.ewm.packoutbdlvs1.view.SerialNumberUiiPopover",this);H.addDependent(O);}if(L){L.close();}O.openBy(y);}else{S.setSerialNumbersList(x.getItemSerialNumber(z));if(!L){L=sap.ui.xmlfragment(H.getId(),"scm.ewm.packoutbdlvs1.view.SerialNumberPopover",this);H.addDependent(L);}if(O){O.close();}L.openBy(y);}},onAfterOpenSerialNumberPopover:function(E){E.getSource().focus();},checkQuantityOverflow:function(Q,i){if(!isNaN(Q)&&U.isQuantityOverflow(Q)){var R=U.formatNumber(Q,3);var W=this.getI18nText("roundUpQuantity");this.updateInputWithWarning(i,W,R);this.focus(i);return true;}return false;},getRouter:function(){return this.getOwnerComponent().getRouter();},navToHome:function(){var i=U.flushPendings.get();if(i){i().then(function(){var x=sap.ushell.Container.getService("CrossApplicationNavigation");var y=(x&&x.hrefForExternal({target:{shellHash:"#Shell-home"}}))||"";var z=window.location.href.split('#')[0]+y.split('?')[0];sap.m.URLHelper.redirect(z,false);}.bind(this));}},playAudio:function(i){var x=this.getAudioFromParent(this.oView);x.play(i);},getAudioFromParent:function(i){if(i.byId&&i.byId(r)){this.oAudio=i.byId(r);}else{this.getAudioFromParent(i.getParent());}return this.oAudio;},setButtonToolTip:function(i){var x=this.byId(i);if(U.isEmpty(x)){return;}var T=x.getTooltip();if(U.isEmpty(T)){x.setTooltip(x.getText());}},getTextAccordingToMode:function(i,O,x,y){var z=U.isEmpty(y)?d.getSelectedMode():y;var E="";if(z===c.INTERNAL_MODE){if(U.isEmpty(x)||x.length===0){E=this.getI18nText(i);}else{E=this.getI18nText(i,x);}}else{if(U.isEmpty(x)||x.length===0){E=this.getI18nText(O);}else{E=this.getI18nText(O,x);}}return E;},getPersonalizationService:function(){return sap.ushell.Container.getService("Personalization");},getPersonalizationContainer:function(){return new Promise(function(i,x){var y=this.getContainerId();this.oPersonalizationService.getContainer(y).fail(function(){var z=this.oPersonalizationService.createEmptyContainer(y);i(z);}.bind(this)).done(function(z){i(z);}.bind(this));}.bind(this));},getContainerId:function(){return d.getSelectedMode()!==c.INTERNAL_MODE?"scm.ewm.packoutbdlvs1":"scm.ewm.packoutbdlvs1.av1";},onTeamsMenuItemPressed:function(){var i=this.getParent();var x=this;while(!(i instanceof sap.ui.core.mvc.XMLView)){i=i.getParent();}i.getController().storeCurrentAppState().done(function(){f.getServiceAsync().then(function(T){var y=this.getModel("share");var z={url:document.URL,appTitle:y.getProperty("/teamsTitle"),subTitle:"",minifyUrlForChat:true};T.share(this.getCustomData()[0].getValue(),z);}.bind(x));});},onShareEmailPressed:function(){this.storeCurrentAppState().done(function(){var i=this.getView().getModel("share");sap.m.URLHelper.triggerEmail(null,i.getProperty("/emailSubject"),document.URL);}.bind(this));},onSaveAsTilePressed:function(){var i=this;this.storeCurrentAppState().done(function(){if(!this.oBookmarkButton){var x=i.getView().getModel("share");this.oBookmarkButton=new A("",{customUrl:x.getProperty("/bookmarkCustomUrl"),title:x.getProperty("/bookmarkTitle"),subtitle:x.getProperty("/bookmarkSubtitle"),tileIcon:x.getProperty("/bookmarkIcon")});}this.oBookmarkButton.firePress();});},storeCurrentAppState:function(){var i=this.oNavigationHandler.storeInnerAppStateAsync(this.getCurrentAppState());i.done(function(x){}.bind(this));i.fail(function(E){this._handleError(E);}.bind(this));return i;},adjustShareMenu:function(E){var i=1;f.getServiceAsync().then(function(T){var x=T.getOptions();if(x.length>0){this.bCollaborationInitialized=true;x.forEach(function(y){if(y.subOptions&&y.subOptions.length>1){var z=[];y.subOptions.forEach(function(K){var H=new sap.m.MenuItem({text:K.text,icon:K.icon,press:this.onTeamsMenuItemPressed});H.addCustomData(new e({key:"data",value:K}));F.setSemanticStepname(H,"press",K.fesrStepName);z.push(H);}.bind(this));this.oShareActionSheet.getMenu().insertItem(new sap.m.MenuItem({text:y.text,icon:y.icon,items:z}),i);}else{var H=new sap.m.MenuItem({text:y.text,icon:y.icon,press:this.onTeamsMenuItemPressed});H.addCustomData(new e({key:"data",value:y}));F.setSemanticStepname(H,"press",y.fesrStepName);this.oShareActionSheet.getMenu().insertItem(H,i);}i++;}.bind(this));}}.bind(this));},showErrorMessagePopup:function(i){var x=!!this.getView().$().closest(".sapUiSizeCompact").length;var y=this.getView().byId(c.ID.PRODUCT_INPUT);M.error(i,{styleClass:x?"sapUiSizeCompact":"",actions:[sap.m.MessageBox.Action.OK],onClose:function(){this.focus(y);}.bind(this)});},getCurrentAppState:function(){var i,x;if(d.isAdvancedMode()){i=k.getJSON();x=l.getJSON();}else if(d.isInternalMode()){i=I.getJSON();x=n.getJSON();}else{i=B.getJSON();x=m.getJSON();}return{globalModel:G.getJSON(),materialModel:h.getJSON(),material:j.getData(),packmodeModel:P.getJSON(),sourceTabelSetting:i,shipTableSetting:x,itemWeight:o.getObject_Cache(),mCache:b.get_mCache(),mIsEmptyHU:b.get_mIsEmptyHU()};},initAppState:function(){if(this.oView.getId().endsWith(D)){return;}var i=this;var x=this.oNavigationHandler.parseNavigation();x.done(function(y,z,E){if(E===sap.fe.navigation.NavType.initial){return;}var H=y.globalModel;if(U.isEmpty(H)){return;}if(i.oView.getId().endsWith(s)){i.restoreGlobal(y);i.restoreSource(y);}else if(i.oView.getId().endsWith(t)){i.restoreShip(y);}});},restoreGlobal:function(i){var x=this;var y=i.globalModel;G.setJSON(y);G.updateBindings(true);var z=i.materialModel;h.setJSON(z);var E=i.material;j.setData(E);h.updateBindings(true);var H=i.packmodeModel;P.setJSON(H);P.updateBindings(true);if(d.isAdvancedMode()||d.isInternalMode()){x.publish(c.EVENT_BUS.CHANNELS.EXCEPTION_LIST,c.EVENT_BUS.EVENTS.SUCCESS,a.getExceptionList());}},restoreSourceTableSetting:function(i){var x=i.sourceTabelSetting;if(d.isAdvancedMode()){k.setJSON(x);k.updateBindings(true);}else if(d.isInternalMode()){I.setJSON(x);I.updateBindings(true);}else{B.setJSON(x);B.updateBindings(true);}},restoreSource:function(i){var x=this;this.restoreSourceTableSetting(i);var W=a.getPackStation();q.verifyWorkCenter(W).then(function(R){a.setAsyncMode(!!R.IsUIAsync);}.bind(this)).then(function(){x.initDefaultColumnSetting();x.initColumnSetting();}.bind(this));var y=i.itemWeight;o.setObject_Cache(y);p.clearAll();b.set_mCache(i.mCache);b.set_mIsEmptyHU(i.mIsEmptyHU);this.oItemHelper.clear();},restoreShipTableSetting:function(i){var x=i.shipTableSetting;if(d.isAdvancedMode()){l.setJSON(x);l.updateBindings(true);}else if(d.isInternalMode()){n.setJSON(x);n.updateBindings(true);}else{m.setJSON(x);m.updateBindings(true);}this.initDefaultColumnSetting();this.initColumnSetting();},restoreShip:function(x){var y=this;this.restoreShipTableSetting(x);if(d.isBasicMode()&&j.getFavoriteMaterials().length!==0){this.getWorkFlowFactory().getInitWorkFlow().run();}this.oItemHelper.clear();var z=-1;var E=a.getCurrentShipHandlingUnit();var H=a.getShipHandlingUnits();this.clearShipHUTabs();if(U.isEmpty(E)||H.lenght===0){return;}this.createTabForShipHUsExist().then(function(){var K=y.oView.byId("shipHUBar");if(a.getShipHandlingUnits().length===0){a.setCurrentShipHandlingUnit("");j.setCurrentMaterial("");}else{E=a.getCurrentShipHandlingUnit();if(d.isBasicMode()){var L=j.getDefaultMaterialId();var O=j.getCurrentMaterial();if(L!==O){j.setFavoriteMaterialSelectedById(L,false);j.setFavoriteMaterialSelectedById(O,true);}}for(var i=0;i<K.getItems().length;i++){if(K.getItems()[i].getKey()===E){z=i;}}if(z!==-1){y.getWorkFlowFactory().getShipHUSelectionWorkFlow().run(E);}}if(!U.isEmpty(a.getSourceId())){y.getWorkFlowFactory().getSourceChangeWorkFlow().run({sReferenceNumber:a.getSourceId(),bToCreateShipHU:d.isBasicMode()?true:false,bReferenceNumberValidated:false,bToSelectProductInSource:true,bToUpdateShipItemStatus:false});}}.bind(this));},createTabForShipHUsExist:function(){var x=a.getShipHandlingUnits();var y=a.getCurrentShipHandlingUnit();this.setBusy(true);var E=[];return new Promise(function(z,H){q.validateShipHUSet(x).then(function(R){this.setBusy(false);var K,L,O;for(var i=R.length;i>=0;i--){if(!U.isEmpty(R[i])){var K=R[i].HuId;E.push(R[i].HuId);if(U.isEmpty(L)&&U.isEmpty(O)){L=R[i].PackagingMaterial;O=R[i].HuId;}if(y===K){L=R[i].PackagingMaterial;O=R[i].HuId;}if(d.isAdvancedMode()||d.isInternalMode()){this.createNewTab(K,c.TAB.ADVANCED);}else{this.createNewTab(K,c.TAB.BASIC);}}}E=E.reverse();a.setShipHandlingUnits(E);a.setCurrentShipHandlingUnit(O);j.setCurrentMaterial(L);z();}.bind(this)).catch(function(i){this.setBusy(false);z();}.bind(this));}.bind(this));}});});
