/*
 * Copyright (C) 2009-2023 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["scm/ewm/packoutbdlvs1/controller/BaseController","sap/m/MessageBox","scm/ewm/packoutbdlvs1/service/ODataService","scm/ewm/packoutbdlvs1/modelHelper/Global","scm/ewm/packoutbdlvs1/utils/Util","scm/ewm/packoutbdlvs1/modelHelper/Material","sap/ui/model/json/JSONModel","scm/ewm/packoutbdlvs1/utils/Const","scm/ewm/packoutbdlvs1/modelHelper/PackingMode","scm/ewm/packoutbdlvs1/model/PackingMode","sap/ui/model/Filter","sap/ui/model/FilterOperator","scm/ewm/packoutbdlvs1/utils/CustomError","scm/ewm/packoutbdlvs1/modelHelper/OData"],function(C,M,S,G,U,a,J,b,P,c,F,d,e,O){"use strict";var s="start-packing-button";var f="dummy-input";var g="audio-player";var w="pod---defaultbin--workcenter--input";var h="pod---defaultbin--storagebin--input";var i="pod---defaultbin--warehouse--input";return C.extend("scm.ewm.packoutbdlvs1.controller.DefaultBin",{sRouteName:"default",init:function(){this.setModel(c,"packingMode");this.setBusy(true);var r=S.getRuntimeEnvironment().then(function(R){if(U.isEmpty(G.getWarehouseNumber())){}else{this.bindAudioAggregation();}G.setIsOnCloud(R[0].IsS4Cloud);if(!R[0].IsS4Cloud&&P.getSelectedMode()!==b.INTERNAL_MODE){this.initPackingModeModel();}}.bind(this));var p=this.initPersonalizationService();this.setButtonToolTip("start-packing-button");return Promise.all([r,p]).then(function(){this.setBusy(false);}.bind(this)).catch(function(){this.setBusy(false);}.bind(this));},onRouteMatched:function(p){this.getOwnerComponent().getService("ShellUIService").then(function(o){o.setBackNavigation();},function(E){jQuery.sap.log.error("Cannot get ShellUIService",E);});},bindWorkCenter:function(W){if(U.isEmpty(G.getWarehouseNumber())){W="";}var j=O.encodeSpecialCharacter(W);this.byId(w).bindElement({path:"/PackingStationSet(EWMWarehouse='"+G.getWarehouseNumber()+"',EWMWorkCenter='"+j+"',EWMStorageBin='')"});},bindStorageBin:function(W,j){if(U.isEmpty(G.getWarehouseNumber())){W="";j="";}if(U.isEmpty(j)){j="";}var k=O.encodeSpecialCharacter(W);this.byId(h).bindElement({path:"/PackingStationSet(EWMWarehouse='"+G.getWarehouseNumber()+"',EWMWorkCenter='"+k+"',EWMStorageBin='"+j+"')"});},bindWarehouse:function(W){var W=O.encodeSpecialCharacter(W);G.setWarehouseNumber(W);this.byId(i).bindElement({path:"/EWMWarehouse_Set(EWMWarehouse='"+W+"')"});},setWarehouseValue:function(W){var o=this.byId("pod---defaultbin--warehouse--input-input");if(!U.isEmpty(o)){o.setValue(W);}var j=this.byId("pod---defaultbin--warehouse--input");j.fireChange({newValue:W,bSKipVerify:true});},initPackingMode:function(){var p=this.getOwnerComponent().getComponentData().startupParameters.PackMode;if(U.isEmpty(p)){p=b.PACK_MODE.OUTBOUND;}else{p=parseInt(p[0],10);}S.setOdataHeader(p);if(p===b.PACK_MODE.OUTBOUND){var j=this.getDefaultPackingModeForOutbound();P.setSelectedMode(j);this.byId("mode-selection").setSelectedKey(j);}else{P.setSelectedMode(b.INTERNAL_MODE);}},initSubscription:function(){},initModel:function(){},isInTextAndIdFormat:function(v){if(v.length<6){return false;}var l=v.substring(v.length-6,v.length-5);if(l!=="("){return false;}var j=v.substring(v.length-1,v.length);if(j!==")"){return false;}return true;},getIdFromTextAndIdFormat:function(v){return v.substring(v.length-5,v.length-1);},initPackingModeModel:function(){var A=this.getI18nText("advancedMode");var B=this.getI18nText("basicMode");var I=this.getI18nText("internalMode");var m=[{"key":b.ADVANCED_MODE,"text":A}];var o={"key":b.BASIC_MODE,"text":B};if(!G.isOnCloud()){m.push(o);}P.setModes(m);},getDefaultPackingModeForOutbound:function(){var D=this.oContainer.getItemValue("packingMode");if(U.isEmpty(D)){D=b.ADVANCED_MODE;}else if(D!==b.ADVANCED_MODE&&D!==b.BASIC_MODE){D=b.ADVANCED_MODE;}return D;},initPersonalizationService:function(){this.oPersonalizationService=this.getPersonalizationService();return new Promise(function(r,j){var k=this.getContainerId();this.oPersonalizationService.getContainer(k).fail(function(){this.oPersonalizationService.createEmptyContainer(k).done(function(o){this.oContainer=o;r();}.bind(this));}.bind(this)).done(function(o){this.oContainer=o;r();}.bind(this));}.bind(this)).then(function(){return this.initDisplayedValue();}.bind(this));},initDisplayedValue:function(){var W=this.oContainer.getItemValue("ewmWarehouse");var j=this.oContainer.getItemValue("workCenter");this.byId(s).setEnabled(false);if(!U.isEmpty(W)){this.setBusy(true);W=W.toUpperCase();j=U.isEmpty(j)?"":j.toUpperCase();S.verifyWarehouseAndWorkCenter(W,j).then(function(r){this.setBusy(false);if(r[0].length===0){G.setWarehouseNumber("");this.bindWarehouse("");this.bindWorkCenter("");this.bindStorageBin("");this.byId(s).setEnabled(false);return;}W=r[0][0].EWMWarehouse;if(r[1].length===0){G.setWarehouseNumber(W);this.bindWarehouse(W);this.bindWorkCenter("");this.bindStorageBin("");this.byId(s).setEnabled(false);return;}var j=r[1][0].EWMWorkCenter;var k=r[1][0].Default_Bin;G.setPackStation(j);G.setBin(k);var p="/PackingStationSet(EWMWarehouse='"+W+"',EWMWorkCenter='"+j+"',EWMStorageBin='"+k+"')";this.bindWarehouse(W);this.byId(w).bindElement({path:p});this.byId(h).bindElement({path:p});if(!U.isEmpty(W)&&!U.isEmpty(j)&&!U.isEmpty(k)){this.byId(s).setEnabled(true);}else{this.byId(s).setEnabled(false);}}.bind(this)).catch(function(){this.setBusy(false);G.setWarehouseNumber("");this.bindWarehouse("");this.bindWorkCenter("");this.bindStorageBin("");}.bind(this));}else{var D=G.getDefaultWarehouseNumber();if(!U.isEmpty(D)){this.bindWarehouse(D);}else{this.bindWarehouse("");}this.bindWorkCenter("");this.bindStorageBin("");}},onVerifyWorkCenter:function(v){var I=this.byId(w);if(v.length>4){this.handleEntryLengthExceed(I);return;}if(!U.isEmpty(v)){this.verifyWorkCenter(v).then(function(){this.setBusy(false);}.bind(this)).catch(function(){this.setBusy(false);}.bind(this));}else{G.setPackStation("");}},onWorkCenterChange:function(E){this.byId(s).setEnabled(false);this.focusDummyElement();var v=U.trim(E.getParameter("newValue")).toUpperCase();if(this.isInTextAndIdFormat(v)){v=this.getIdFromTextAndIdFormat(v);}if(U.isEmpty(E.getParameter("validated"))||!E.getParameter("validated")){this.onVerifyWorkCenter(v);}},handleEntryLengthExceed:function(I){var E=this.getI18nText("workCenterMaximunCharacters");this.updateInputWithError(I,E);this.playAudio(b.ERROR);I.focus();},verifyWorkCenter:function(v,B,j){var I=this.byId(w);var D="";this.setBusy(true);var j=U.isEmpty(j)?true:j;return S.verifyWorkCenter(v).then(function(r){this.setBusy(false);if(U.isEmpty(r.EWMWarehouse)||U.isEmpty(r.EWMWorkCenter)){throw new Error();}else{G.setPackStation(r.EWMWorkCenter);G.setScaleEnabled(r.ScaleEnabled);G.setAsyncMode(!!r.IsUIAsync);if(U.isEmpty(r.CheckConsGrp)){G.setCheckConsolidationGroup(false);}else{G.setCheckConsolidationGroup(true);}var W=r.EWMWorkCenter.toUpperCase();D=r.EWMStorageBin.toUpperCase();if(B){this.bindWorkCenter(W);}if(j){this.bindStorageBin(W,D);}}}.bind(this)).then(function(){if(j&&!U.isEmpty(D)){G.setBin(D);this.updateInputWithDefault(h,D);this.byId(s).setEnabled(true);}else{var o=this.byId(h);var k=o.getValue();if(!U.isEmpty(k)){o.fireChange({newValue:k});}else{this.updateInputWithDefault(o,"");}}this.focus(h);}.bind(this)).catch(function(E){this.setBusy(false);this.byId(s).setEnabled(false);if(U.isEmpty(E._vPara)){var k=this.getI18nText("incorrectWorkCenter",v);this.updateInputWithError(I,k);}else{this.updateInputWithError(I,E._vPara.MsgVar);}G.setPackStation("");this.playAudio(b.ERROR);I.focus();}.bind(this));},onWarehouseVerify:function(v){var W=this.byId(i);var o=this.byId(w);if(v.length>4){var E=this.getI18nText("incorrectWarehouse",v);this.updateInputWithError(W,E);this.playAudio(b.ERROR);W.focus();return;}if(U.isEmpty(v)){var E=this.getI18nText("specifyWarehouse");this.updateInputWithError(W,E);this.playAudio(b.ERROR);W.focus();return;}this.setBusy(true);return S.verifyWarehouse(v).then(function(r){this.setBusy(false);if(r.length==0){var E=this.getI18nText("warehouseNotExist",[v]);this.updateInputWithError(W,E);this.playAudio(b.ERROR);W.focus();}else{G.setWarehouseNumber(r[0].EWMWarehouse);this.setWarehouseValue(r[0].EWMWarehouse);this.bindWorkCenter("");this.bindStorageBin("");this.byId(w).setEditable(true);this.byId(h).setEditable(true);o.focus();}}.bind(this)).catch(function(j){this.setBusy(false);var E=this.getI18nText("specifyWarehouse");this.updateInputWithError(W,E);this.playAudio(b.ERROR);W.focus();}.bind(this));},onStorageBinVerify:function(v){var W=this.byId(w);var j=G.getPackStation();var I=this.byId(h);if(U.isEmpty(j)){W.focus();this.updateInputWithDefault(I,v);return;}if(v.length>18){this.updateInputWithError(I);this.playAudio(b.ERROR);I.focus();return;}if(!U.isEmpty(v)){this.verifyStorageBin(v);}else{G.setBin("");}},onWorkCenterValueListChanged:function(E){if(U.isEmpty(E.getParameter("changes"))){return;}var W=E.getParameter("changes").EWMWarehouse;var D=E.getParameter("changes").Default_Bin;var p=this.byId(w).getBinding("value").getContext().getPath();var j=p.indexOf("EWMWorkCenter='")+15;var k=p.indexOf("',EWMStorageBin=");var l=p.substring(j,k);if(U.isEmpty(W)){var o=this.byId(i);this.updateInputWithDefault(o,"");this.setWarehouseValue("");o.focus();this.UIChangeWhenWarehouseNumberIsEmpty();var m=this.getI18nText("specifyWarehouse");this.updateInputWithError(o,m);this.playAudio(b.ERROR);return;}if(G.getWarehouseNumber(W)!==W){G.setWarehouseNumber(W);this.setWarehouseValue(W);if(!U.isEmpty(l)){this.verifyWorkCenter(l,false,true);}}else{G.setPackStation(l);G.setBin(D);var n=this.byId("pod---defaultbin--storagebin--input-input");n.setValue(D);var q=this.byId("pod---defaultbin--storagebin--input");q.fireChange({newValue:D,bSKipVerify:true});if(!U.isEmpty(D)){this.byId(s).setEnabled(true);}else{this.byId(s).setEnabled(false);}return;}},onStorageBinValueListChanged:function(E){if(U.isEmpty(E.getParameter("changes"))){return;}var W=E.getParameter("changes").EWMWarehouse;if(U.isEmpty(W)){var o=this.byId(i);this.updateInputWithDefault(o,"");this.setWarehouseValue("");o.focus();this.UIChangeWhenWarehouseNumberIsEmpty();var j=this.getI18nText("specifyWarehouse");this.updateInputWithError(o,j);this.playAudio(b.ERROR);return;}if(G.getWarehouseNumber(W)!==W){G.setWarehouseNumber(W);this.setWarehouseValue(W);}var k=this.byId(w).getProperty("value");if(!U.isEmpty(k)){this.verifyWorkCenter(k,true,false);}else{this.bindWorkCenter("");}},UIChangeWhenWarehouseNumberIsEmpty:function(){this.byId(s).setEnabled(false);G.setWarehouseNumber("");G.setPackStation("");G.setBin("");this.bindWorkCenter("");this.bindStorageBin("");this.updateInputWithDefault(this.byId(w),"");this.updateInputWithDefault(this.byId(h),"");this.byId(w).setEditable(false);this.byId(h).setEditable(false);},onWarehouseChange:function(E){if(!U.isEmpty(E.getParameter("bSKipVerify"))&&E.getParameter("bSKipVerify")){return;}this.UIChangeWhenWarehouseNumberIsEmpty();if(!U.isEmpty(E.getParameter("validated"))&&E.getParameter("validated")===true){var W=E.getParameter("value");if(U.isEmpty(W)){var o=this.byId(i);o.focus();}else{G.setWarehouseNumber(W);this.bindWorkCenter("");this.bindStorageBin("");this.updateInputWithDefault(this.byId(w),"");this.updateInputWithDefault(this.byId(h),"");this.byId(w).setEditable(true);this.byId(h).setEditable(true);var j=this.byId(w);j.focus();}return;}this.focusDummyElement();var v=U.trim(E.getParameter("newValue")).toUpperCase();if(this.isInTextAndIdFormat(v)){v=this.getIdFromTextAndIdFormat(v);}this.onWarehouseVerify(v);},onStorageBinChange:function(E){if(!U.isEmpty(E.getParameter("bSKipVerify"))&&E.getParameter("bSKipVerify")){return;}this.byId(s).setEnabled(false);this.focusDummyElement();var v=U.trim(E.getParameter("newValue")).toUpperCase();if(U.isEmpty(E.getParameter("validated"))||!E.getParameter("validated")){this.onStorageBinVerify(v);}},verifyStorageBin:function(v){var I=this.byId(h);this.setBusy(true);return S.verifyStorageBin(v).then(function(r){this.setBusy(false);G.setBin(r.EWMStorageBin);this.updateInputWithDefault(I,v);this.byId(s).setEnabled(true);I.focus();this.byId(w).setEnabled(true);this.byId(h).setEnabled(true);}.bind(this)).catch(function(E){this.setBusy(false);if(U.isEmpty(E._vPara)){var j=this.getI18nText("incorrectStorageBin",v);this.updateInputWithError(I,j);}else{this.updateInputWithError(I,E._vPara.MsgVar);}this.playAudio(b.ERROR);I.focus();}.bind(this));},onStartPacking:function(E){var W=G.getPackStation();var j=this.byId(h).getValue();var m=P.getSelectedMode();this.setBusy(true);S.getMaterialAndExceptionList().then(function(r){if(r[0].length===0){throw new e(b.ERRORS.NO_MATERIAL);}else{a.setData(r[0]);}G.setExceptionList(r[1]);}.bind(this)).then(function(){this.oContainer.setItemValue("workCenter",W);this.oContainer.setItemValue("storageBin",j);this.oContainer.setItemValue("ewmWarehouse",G.getWarehouseNumber());if(P.getSelectedMode()!==b.INTERNAL_MODE){this.oContainer.setItemValue("packingMode",m);}return this.oContainer.save();}.bind(this)).then(function(){var r=this.getRouter();if(m===b.ADVANCED_MODE){r.navTo(b.ADVANCED_ROUTE_NAME);}else if(m===b.BASIC_MODE){if(a.getFavoriteMaterials().length===0){throw new e(b.ERRORS.NO_FAVORITE_MATERIAL);}else{r.navTo(b.BASIC_ROUTE_NAME);}}else{r.navTo(b.INTERNAL_ROUTE_NAME);}}.bind(this)).then(function(){this.setBusy(false);}.bind(this)).catch(function(o){if(U.isEmpty(o._vPara)){if(o._sKey===b.ERRORS.NO_MATERIAL){var k=this.getI18nText("noMaterialInWarehouse",G.getWarehouseNumber());this.showErrorMessageBox(k);}else if(o._sKey===b.ERRORS.NO_FAVORITE_MATERIAL){var l=this.getI18nText("noFavoriteMaterialInWorkCenter",G.getPackStation());this.showErrorMessageBox(l);}}this.setBusy(false);}.bind(this));},onDefaultInputLiveChanged:function(){this.byId(s).setEnabled(false);},focusDummyElement:function(){this.byId(f).setValue("");this.byId(f).focus();},onPackingModeChange:function(E){var o=this.byId("mode-selection");var n=o.getSelectedKey();P.setSelectedMode(n);var W=G.getPackStation();var j=G.getBin();if(!U.isEmpty(W)&&!U.isEmpty(j)){this.byId(s).setEnabled(true);}},bindAudioAggregation:function(){var A=this.getAudioParent(this.oView);var W=new F("EWMWarehouse",d.EQ,G.getWarehouseNumber());A.getController().bindAudioList([W]);},getAudioParent:function(v){if(v.byId&&v.byId(g)){this.oAudio=v;}else{this.getAudioParent(v.getParent());}return this.oAudio;},filterTable:function(t,k,j){t.filter(U.getFilters(k,j));},formatUpperCase:function(v){if(!U.isEmpty(v)){return v.toUpperCase();}else{return"";}}});});
