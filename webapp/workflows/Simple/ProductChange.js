/*
 * Copyright (C) 2009-2023 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["scm/ewm/packoutbdlvs1/workflows/WorkFlow","scm/ewm/packoutbdlvs1/utils/Util","scm/ewm/packoutbdlvs1/utils/Const","scm/ewm/packoutbdlvs1/modelHelper/Global","scm/ewm/packoutbdlvs1/utils/CustomError","scm/ewm/packoutbdlvs1/modelHelper/Message"],function(W,U,C,G,a,M){"use strict";return function(s,S,f){var w=new W().then(function(p,m){G.setSelectedProductInSource("");var P;m.bToPackProduct=true;if(!U.isEmpty(p.bToPackProduct)){P=p.oProduct;m.bToPackProduct=p.bToPackProduct;}else{P=p;}return this.getItemIndexByProductOrEAN(P,m);},s).then(function(p,m){this.prepareDataForProductChangeWorkFlow(m);},s).then(function(p,m){this.getItemIndexByProductAndActiveConsGroup(m);},s).then(function(p,m){if(U.isEmpty(m.sShipConsGroup)||m.oProduct.EWMConsolidationGroup===m.sShipConsGroup){this.oItemHelper.sortItemsByKey(m.oProduct.StockItemUUID,m.oProduct.Huident);}},s).then(function(p,m){this.updateUIElementsAfterProductChange();},s).then(function(p,m){if(m.bToPackProduct){if(U.isEmpty(m.sShipConsGroup)||m.oProduct.EWMConsolidationGroup===m.sShipConsGroup||!G.getCheckConsolidationGroup()){var q;if(U.parseNumber(m.oProduct.AlterQuan)<1&&U.parseNumber(m.oProduct.AlterQuan)>0){q=m.oProduct.AlterQuan;}else{q="1";}var P={oProduct:m.oProduct,sQuantity:q,iIndex:0,bAdd:true};f.getPackItemWorkFlow().run(P);}else{throw new a(C.ERRORS.PRODUCT_WITH_DIFF_CONS_GROUP);}}},s).then(function(p,P){P.sODO="";P.sPackInstr="";if(this.oItemHelper.getHighLightedItemIndex()===0){P.sODO=this.oItemHelper.getItemDocNoByIndex(0);P.sPackInstr=this.oItemHelper.getItemPackInstrByIndex(0);}},s).then(function(p,P){this.updatePackingInstr(P.sODO,P.sPackInstr);},S,"update packing info").then(function(p,m){this.delayCalledAdjustContainerHeight();},S).then(function(p,m){G.setSelectedProductInSource(this.oItemHelper.getItemByIndex(0));},s);w.errors().subscribe(C.ERRORS.PRODUCT_NOT_IN_SOURCE,function(e,p,m){var E;if(G.getSourceId()){E=this.getTextAccordingToMode("productNotInSource","productNotInReference",[m.sProduct,G.getSourceId()]);}else{E=this.getTextAccordingToMode("provideHUFirst","provideReferenceFirst");}this.updateInputWithError(C.ID.PRODUCT_INPUT,E);},s).subscribe(C.ERRORS.PRODUCT_WITH_DIFF_CONS_GROUP,function(){var m=this.getTextAccordingToMode("differentConsGroupWithHUMsg","differentConsGroupWithShipHUMsg");this.updateInputWithError(C.ID.PRODUCT_INPUT,m);},s).default(function(e){s.updateInputWithError(C.ID.PRODUCT_INPUT,e);}).always(function(){G.setProductId("");s.focus(C.ID.PRODUCT_INPUT);s.unbindProductInfo();s.oItemHelper.setItemsStatusByConsGrp();s.playAudio(C.ERROR);S.clearPackingInstr();});return w;};});
