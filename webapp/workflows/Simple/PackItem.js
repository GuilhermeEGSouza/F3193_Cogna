/*
 * Copyright (C) 2009-2023 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["scm/ewm/packoutbdlvs1/workflows/MixedWorkFlow","scm/ewm/packoutbdlvs1/utils/CustomError","scm/ewm/packoutbdlvs1/service/ODataService","scm/ewm/packoutbdlvs1/utils/Util","scm/ewm/packoutbdlvs1/utils/Const","scm/ewm/packoutbdlvs1/modelHelper/Message","scm/ewm/packoutbdlvs1/modelHelper/Cache","scm/ewm/packoutbdlvs1/modelHelper/Global"],function(W,C,S,U,a,M,b,G){"use strict";return function(s,o){var w=new W().then(function(p,m){this.setBusy(true);m.oProduct=p.oProduct;m.oPackProduct=JSON.parse(JSON.stringify(p.oProduct));m.oPackProduct.PackedQuan=p.oProduct.PackedQuan?p.oProduct.PackedQuan:0;m.oPackProduct.AlterQuan=p.sQuantity;m.iIndex=p.iIndex;m.bAdd=p.bAdd;},s).then(function(p,m){if(!U.isEmpty(m.oProduct.SerialNumberRequiredLevel)||!U.isEmpty(m.oProduct.Batch)){throw new C();}},s).then(function(p,m){if(m.oProduct.AlterQuan-m.oPackProduct.AlterQuan>0){this.oItemHelper.reduceItemAlterQtyByIndex(m.iIndex,m.oPackProduct.AlterQuan);this.oItemHelper.setItemHighlightByIndex(0);}else{this.oItemHelper.deleteItem(m.oProduct);G.setProductId("");this.unbindProductInfo();}if(U.parseNumber(m.oProduct.QtyReduced)!==0){throw new C();}},s).then(function(p,m){m.bShipHUEmptyBeforePack=this.oItemHelper.isEmpty();var i;m.sNewStockItemUUID=this.oItemHelper.getItemStockIdByOriginalId(m.oPackProduct.StockItemUUID);if(!U.isEmpty(m.sNewStockItemUUID)){i=this.oItemHelper.findItemAndIndexByStockIdAndOriginId(m.sNewStockItemUUID,m.oPackProduct.StockItemUUID,m.oPackProduct.Huident)[0];this.oItemHelper.updateItemStockId(m.oPackProduct,m.sNewStockItemUUID);}if(i&&!i.AlterQuan){i.AlterQuan=i.PreviousAlterQuan;}if(i&&i.DefaultAltQuan!==m.oProduct.DefaultAltQuan){m.oProduct.DefaultAltQuan=i.DefaultAltQuan;m.oPackProduct.DefaultAltQuan=i.DefaultAltQuan;}if(i&&i.PackedQuan!==m.oPackProduct.PackedQuan){m.oPackProduct.PackedQuan=i.PackedQuan;}if(m.bAdd){this.oItemHelper.addItem(m.oPackProduct,true);}this.oItemHelper.setItemDeltaByIndex(m.iIndex,U.parseNumber(m.oPackProduct.AlterQuan),a.OPERATOR.PLUS);this.oItemHelper.setItemPreviousAlterQuanByIndex(m.iIndex,this.oItemHelper.getItemDeltaByIndex(m.iIndex).toString());},o).asyncOnly(function(p,m){this.oItemHelper.updatePendingStatus(m.oPackProduct,true);},o,"disable the input of the quantity once it is ready to send the pack reqeust").service(function(p,m){var i=this.oItemHelper.getItemByKey(m.oPackProduct.StockItemUUID,m.oPackProduct.Huident);if(i.DefaultAltQuan===i.OperationDeltaQuan||m.oPackProduct.AlterQuan==="0"){var P=JSON.parse(JSON.stringify(i));P.StockItemUUID=P.OriginId;if(P.PackedQuan){P.AlterQuan=(U.parseNumber(P.AlterQuan)-P.PackedQuan).toString();}var q="";if(i.DefaultAltQuan>i.OperationDeltaQuan){q=parseFloat(P.AlterQuan);}return S.pack(P,q).then(function(r){this.oItemHelper.setItemPackedQuan(m.oPackProduct,U.parseNumber(i.AlterQuan));this.oItemHelper.updateItemStockIdByKey(m.oPackProduct.StockItemUUID,r.StockItemUUID,m.oPackProduct.Huident);}.bind(this));}},o).serviceCallback(function(p,m){this.oItemHelper.updatePendingStatus(m.oPackProduct,false);},o,"enable the quantity input once the pack item request responsed successfully").then(function(){this.focus(a.ID.PRODUCT_INPUT);},s).then(function(p,m){this.clearGrossWeight();var t=this.byId("ShipProductTable");var i=t.getItems()[0].getCells()[2];if(i.getValueState()==="Error"){this.updateInputWithDefault(i);}},o,"clear qunatity input error in the ship table").then(function(p,m){if(m.bShipHUEmptyBeforePack){b.updateShipHUConsGroup(G.getCurrentShipHandlingUnit(),m.oProduct.EWMConsolidationGroup);}this.setBusy(false);this.oItemHelper.setItemsStatusToNone();this.oItemHelper.setItemHighlightByIndex(0);},o,"if it is the first item in the right, update packing info").then(function(p,P){P.sODO="";P.sPackInstr="";if(this.oItemHelper.getHighLightedItemIndex()===0){P.sODO=this.oItemHelper.getItemDocNoByIndex(0);P.sPackInstr=this.oItemHelper.getItemPackInstrByIndex(0);}},s).then(function(p,P){this.updatePackingInstr(P.sODO,P.sPackInstr);},o,"update packing info").then(function(p,m){this.delayCalledAdjustContainerHeight();},o);w.errors().default(function(e,p,m,c){if(c){this.showErrorMessagePopup(e);}},s).always(function(e,p,m){var i=o.oItemHelper.getItemByKey(m.oPackProduct.StockItemUUID,m.oPackProduct.Huident);var n=JSON.parse(JSON.stringify(m.oPackProduct));n.StockItemUUID=n.OriginId;var h=!!i.PackedQuan;if(h){n.AlterQuan=(i.DefaultAltQuan-i.PackedQuan).toString();i.OperationDeltaQuan=i.PackedQuan;o.oItemHelper.updateItemBothAlterQuantity(i,i.PackedQuan.toString());this.oItemHelper.updateItem(n);}else{o.oItemHelper.deleteItem(i);if(!o.oItemHelper.isEmpty()){o.oItemHelper.setItemHighlightByIndex(0);}i.OperationDeltaQuan=0;n.AlterQuan=this.oItemHelper.getItemByKey(m.oProduct.StockItemUUID,m.oPackProduct.Huident)?i.AlterQuan:i.DefaultAltQuan.toString();this.oItemHelper.addItem(n);}this.oItemHelper.setItemsStatusByConsGrp();this.setBusy(false);this.focus(a.ID.PRODUCT_INPUT);this.playAudio(a.ERROR);},s);return w;};});
