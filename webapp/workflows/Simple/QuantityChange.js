/*
 * Copyright (C) 2009-2023 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["scm/ewm/packoutbdlvs1/workflows/WorkFlow","scm/ewm/packoutbdlvs1/utils/Util","scm/ewm/packoutbdlvs1/service/ODataService","scm/ewm/packoutbdlvs1/utils/CustomError","scm/ewm/packoutbdlvs1/utils/Const","scm/ewm/packoutbdlvs1/modelHelper/Message","scm/ewm/packoutbdlvs1/modelHelper/Global"],function(W,U,S,C,a,M,G){"use strict";return function(s,o,f){var w=new W().then(function(O,m){m.oProduct=JSON.parse(JSON.stringify(O.oProduct));m.iApplyQuantity=O.iQuantity;if(m.iApplyQuantity>0){m.pack=true;}else if(m.iApplyQuantity<=0){m.pack=false;}m.mSource=O.mSource;},o).then(function(p,m){if(m.pack){return;}var i=this.oItemHelper.getItemIndexByKey(m.oProduct.StockItemUUID,m.oProduct.Huident);var u={oProduct:m.oProduct,iQuantity:Math.abs(m.iApplyQuantity),iIndex:i};return f.getUnpackWorkFlow().run(u);},o).then(function(p,m){if(!m.pack){return;}var i=this.oItemHelper.getItemIndexByKey(m.oProduct.StockItemUUID,m.oProduct.Huident);if(i===-1){throw new C(a.ERRORS.NO_ENOUGH_QUANTITY_APPLIED,m);}m.oApplyProduct=this.oItemHelper.getItemByIndex(i);if(m.iApplyQuantity>U.parseNumber(m.oApplyProduct.AlterQuan)){throw new C(a.ERRORS.NO_ENOUGH_QUANTITY_APPLIED,m);}var P={oProduct:m.oApplyProduct,sQuantity:m.iApplyQuantity.toString(),iIndex:i,bAdd:false};return f.getPackItemWorkFlow().run(P);},s).then(function(p,P){P.sODO="";P.sPackInstr="";if(this.oItemHelper.getHighLightedItemIndex()===0){P.sODO=this.oItemHelper.getItemDocNoByIndex(0);P.sPackInstr=this.oItemHelper.getItemPackInstrByIndex(0);}},s).then(function(p,P){this.updatePackingInstr(P.sODO,P.sPackInstr);},o,"update packing info").then(function(p,m){this.clearGrossWeight();this.updateInputWithDefault(m.mSource);},o);w.errors().subscribe(a.ERRORS.NO_ENOUGH_QUANTITY_APPLIED,function(m){var e=this.getI18nText("noEnoughQuantityPack",m.oProduct.DefaultAltQuan);this.updateInputWithError(m.mSource,e);},o).always(function(e,p,m){this.playAudio(a.ERROR);},o);return w;};});
