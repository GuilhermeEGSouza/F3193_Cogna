/*
 * Copyright (C) 2009-2023 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["scm/ewm/packoutbdlvs1/workflows/WorkFlow","scm/ewm/packoutbdlvs1/utils/Util","scm/ewm/packoutbdlvs1/modelHelper/Global","scm/ewm/packoutbdlvs1/modelHelper/Material","scm/ewm/packoutbdlvs1/service/ODataService","scm/ewm/packoutbdlvs1/utils/CustomError","scm/ewm/packoutbdlvs1/modelHelper/Cache","scm/ewm/packoutbdlvs1/utils/Const"],function(W,U,G,M,S,C,a,b){"use strict";var s="source-hu-input";return function(o,c,f){var w=new W().then(function(p,m){this.setBusy(true);m.sInput=p.sReferenceNumber;this.updateInputWithDefault(s,"");m.bToCreateShipHU=p.bToCreateShipHU===false?false:true;m.bToSelectProductInSource=p.bToSelectProductInSource===true?true:false;},o,"disable ui interaction").then(function(p,m){if(!this.oItemHelper.isEmpty()){return this.flushPendings();}},c).then(function(r,m){if(G.isShipHandlingUnitExist(m.sInput)){return this.getHandlingUnitDisplayWhenScanOnOtherSide();}},c,"if the user scans the ship hu, determine how to display it").then(function(p,m){if(G.isShipHandlingUnitExist(m.sInput)){if(m.sInput===G.getCurrentShipHandlingUnit()){var d={"bClearSource":false,"bClearShip":true};this.getWorkFlowFactory().getClearWorkFlow().run(d);}}},c,"remove ship hu if need").then(function(){this.byId("product-info").unbindElement();this.oItemHelper.clear();G.setProductId("");},o,"clear the info of previouse source hu/bin").then(function(p,P){this.clearPackingInstr();},c,"update packing info").then(function(p,m){return S.convertHUID(m.sInput);},o,"conver hu id").then(function(p,m){m.sInput=p.Huident;this.setBusy(true);return S.verifySource(m.sInput);},o,"verify input").then(function(r){if(r.Closed){throw new C(b.ERRORS.SHIP_HU_ALREADY_CLOSED);}G.setPackAllEnable(false);G.setSourceId(r.SourceId);G.setSourceType(r.SourceType);G.setSourceMaterialId(r.PackagingMaterial);G.setIsPickHUInSourceSide(r.IsPickHU);},o,"set gloable model").then(function(){return S.getHUItems(G.getSourceId());},o,"request the HU/Bin items").then(function(i,m){this.oItemHelper.setItems(i);if(i.length!==0){this.oItemHelper.setItemsStatusByConsGrp();this.oItemHelper.setItemsDefaultQuan();}m.aItem=i;},o,"update items info to helper method").then(function(p,m){if(this.oItemHelper.isSerialNumberEnable()||this.oItemHelper.isBatchEnable()){throw new C(b.ERRORS.NOT_SUPPORT_SN_BATCH,this.getI18nText("serialNumberOrBatchManagedNotSupport"));}if(this.oItemHelper.isItemSplitEnable()){throw new C(b.ERRORS.NOT_SUPPORT_STOCK_ID_SPLIT,this.getI18nText("stockIdSplitNotSupport"));}if(this.oItemHelper.isMultipleSourceLocation()){throw new C(b.ERRORS.NOT_SUPPORT_MULTI_SOURCE_LOCATION,this.getI18nText("multipleSourceLocationNotSupport"));}},o,"throw error message if contains s/n or batch").then(function(p,m){var d=G.getCurrentShipHandlingUnit();if(!U.isEmpty(d)){var e=a.getShipHUConsGroup(d);if(!U.isEmpty(e)&&m.aItem.length!==0&&!this.oItemHelper.isItemsContainsConsGroup(e)&&G.getCheckConsolidationGroup()){var g=this.getTextAccordingToMode("differentConsGroupWithHUMsg","differentConsGroupWithShipHUMsg");this.showErrorMessageBox(g);}}},o,"throw error message if doesn't contain groups belong to current ship hu").then(function(p,m){if(m.bToCreateShipHU&&m.aItem.length!==0&&!G.hasOpenShipHandlingUnit()&&M.getDefaultMaterialId()){return f.getShipHUCreationWorkFlow().run({sHuId:"",sMaterialId:M.getDefaultMaterialId()}).getResult();}else if(U.isEmpty(M.getDefaultMaterialId())&&!G.hasOpenShipHandlingUnit()){var e=this.getI18nText("materialEmptyMsg");throw new C(b.ERRORS.NO_PACKAGING_MATERIAL_SELECTED,e);}},c,"auto create a ship hu, if no ship hu and has a default material").then(function(){this.handlePackAllEnable();},o,"enable pack all if the items of source/ship hu belongs to same consolidation group").then(function(){this.updateShipItemStatus();},c,"update status of ship hu item").then(function(){this.setBusy(false);this.updateInputWithDefault(b.ID.PRODUCT_INPUT,"");this.focus(b.ID.PRODUCT_INPUT);},o,"enable ui interaction").then(function(p,m){this.delayCalledAdjustContainerHeight();},c).then(function(p,m){if(m.bToSelectProductInSource){var P=G.getSelectedProductInSource();if(!U.isEmpty(P)){var i=this.oItemHelper.getItemIndexByKey(P.StockItemUUID,P.Huident);if(i>=0){var d={bToPackProduct:false,oProduct:P};this.getWorkFlowFactory().getProductChangeWorkFlow().run(d);}}}},o,"select one product in source table");;w.errors().subscribe(b.ERRORS.HU_NOT_EXIST,function(e){this.updateInputWithError(s,e);},o).subscribe(b.ERRORS.BIN_NOT_EXIST,function(){var e=this.getI18nText(b.ERRORS.BIN_NOT_EXIST);this.updateInputWithError(s,e);},o).subscribe(b.ERRORS.BIN_NOT_IN_PACKING_STATION,function(){var e=this.getI18nText(b.ERRORS.BIN_NOT_EXIST);this.updateInputWithError(s,e);},o).subscribe(b.ERRORS.SOURCE_NO_ITEM,function(){var e=this.getTextAccordingToMode("sourceWithoutItem","sourceNoItem",[G.getSourceId()]);this.updateInputWithError(s,e);},o).subscribe(b.ERRORS.SCAN_SHIPHU_IN_SOURCE_INPUT,function(){var e=this.getTextAccordingToMode("scanHUInSourceInput","scanShipInSourceInput",[G.getSourceId()]);this.updateInputWithError(s,e);},o).subscribe(b.ERRORS.HU_NOT_IN_WORK_CENTER,function(e){this.updateInputWithError(s,e);},o).subscribe(b.ERRORS.STORAGE_BIN_NOT_IN_WAREHOUSE,function(e){this.updateInputWithError(s,e);},o).subscribe(b.ERRORS.NOT_SUPPORT_SN_BATCH,function(e){this.updateInputWithError(s,e);},o).subscribe(b.ERRORS.NOT_SUPPORT_STOCK_ID_SPLIT,function(e){this.updateInputWithError(s,e);},o).subscribe(b.ERRORS.NO_PACKAGING_MATERIAL_SELECTED,function(e){this.showErrorMessagePopup(e);},o).subscribe(b.ERRORS.NO_AUTHORIZATION_FOR_WAREHOUSE,function(e){this.showToLeaveMessagePopup(e);},o).subscribe(b.ERRORS.SHIP_HU_ALREADY_CLOSED,function(e,p,m){var E=this.getTextAccordingToMode("HUClosedMsg","shipHUClosedMsg",[m.sInput]);this.updateInputWithError(b.ID.SOURCE_INPUT,E);},o).default(function(e){this.updateInputWithError(s,e);},o).always(function(){this.setBusy(false);this.oItemHelper.setItems([]);this.byId("product-info").unbindElement();G.setSourceId("");G.setPackAllEnable(false);this.focus(s);this.playAudio(b.ERROR);},o);return w;};});
