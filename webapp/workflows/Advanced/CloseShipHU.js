/*
 * Copyright (C) 2009-2023 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["scm/ewm/packoutbdlvs1/workflows/MixedWorkFlow","scm/ewm/packoutbdlvs1/utils/Util","scm/ewm/packoutbdlvs1/utils/Const","scm/ewm/packoutbdlvs1/modelHelper/Message","scm/ewm/packoutbdlvs1/modelHelper/Global","scm/ewm/packoutbdlvs1/modelHelper/Cache","scm/ewm/packoutbdlvs1/service/ODataService"],function(W,U,C,M,G,a,S){"use strict";return function(s,o){var w=new W().then(function(c,m){m.bClosed=c;this.setBusy(true);},o).asyncOnly(function(p,m){var b=new Promise(function(r,c){W.setObserver(r,c);});return b;},o).then(function(c,m){if(!m.bClosed){return S.closeShipHandlingUnit();}},o,"send close request to backend only when the hu is open.").then(function(p,m){if(!m.bClosed){if(p.MsgVar===""){var c=G.getCurrentShipHandlingUnit();var b=this.getTextAccordingToMode("closeHU","closeShippingHU",[c]);M.addSuccess(b);this.playAudio(C.INFO);}}},o,"show success message only when the ship hu is already closed before displayed on the ui ").then(function(p,m){this.setBusy(false);this.updateInputWithDefault(C.ID.SHIP_INPUT,"");},o).then(function(p,P){var c=G.getCurrentShipHandlingUnit();a.clearShipHU(c);this.deleteCurrentShipHandlingUnit();return this.removeTabByTabName(c);},o,"delete items from ship table, delete current shipHU from Global").then(function(p,P){if(G.hasOpenShipHandlingUnit()){var b=G.getShipHandlingUnits()[0];this.setCurrentShipHandlingUnit(b);return this.selectTabByTabName(b);}},o,"select next ship handling unit").then(function(p,P){if(!G.hasOpenShipHandlingUnit()){this.oInitTab.setVisible(true);this.setCurrentShipHandlingUnit("");this.handleUnpackEnable();}},o,"display the intial tab").then(function(p,P){P.sConGroupOfFirstSourceItem="";if(!U.isEmpty(G.getSourceId())&&!this.oItemHelper.isEmpty()){P.sConGroupOfFirstSourceItem=this.oItemHelper.getFirstItemConsGroup();}},s,"get consolidation group of the selected source product").then(function(p,m){this.dehilightShipHandlingUnits();if(!U.isEmpty(G.getProductId())){var h=this.getHightlightShipHandlingUnits(m.sConGroupOfFirstSourceItem);if(h.length>0){this.hilightShipHandlingUnits(h);}}},o,"highlight ship handling unit if possible").then(function(){this.oItemHelper.setItemsStatusByConsGrp();this.handleExceptionEnable();this.updateSourceItemStatus();this.handlePackAllEnable();},s).then(function(p,P){P.bHasSourceItem=!this.oItemHelper.isEmpty();if(!P.bHasSourceItem&&!G.hasOpenShipHandlingUnit()){this.focus(C.ID.SOURCE_INPUT);}else{this.focus(C.ID.PRODUCT_INPUT);}},s).then(function(p,P){if(P.bHasSourceItem&&this.needAutoCreateShippingHU(P.sConGroupOfFirstSourceItem)){this.onOpenCreateShipHUDialog();}},o,"open createshiphu dialog if there is no open ship hu").then(function(p,P){P.sODO="";P.sPackInstr="";if(this.oItemHelper.getHighLightedItemIndex()===0){P.sODO=this.oItemHelper.getItemDocNoByIndex(0);P.sPackInstr=this.oItemHelper.getItemPackInstrByIndex(0);}},s).then(function(p,P){this.updatePackingInstr(P.sODO,P.sPackInstr);this.updateInputWithDefault(C.ID.SHIP_INPUT,"");},o,"update packing info");w.errors().default(function(e,p,m,c){if(c){this.showErrorMessagePopup(e);}},s).always(function(){this.setBusy(false);this.playAudio(C.ERROR);},o);return w;};});
