/*
 * Copyright (C) 2009-2023 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["scm/ewm/packoutbdlvs1/workflows/WorkFlow","scm/ewm/packoutbdlvs1/utils/Util","scm/ewm/packoutbdlvs1/service/ODataService","scm/ewm/packoutbdlvs1/modelHelper/Global","scm/ewm/packoutbdlvs1/modelHelper/OData","scm/ewm/packoutbdlvs1/utils/Const","scm/ewm/packoutbdlvs1/modelHelper/ItemWeight","scm/ewm/packoutbdlvs1/utils/CustomError","sap/m/MessageBox","scm/ewm/packoutbdlvs1/modelHelper/Message","scm/ewm/packoutbdlvs1/modelHelper/Cache","scm/ewm/packoutbdlvs1/modelHelper/PackingMode"],function(W,U,S,G,O,C,I,a,M,b,c,P){"use strict";return function(s,o){var w=new W().then(function(p,m){m.sInput=p.sReferenceNumber;m.bReferenceNumberValidated=!!p.bReferenceNumberValidated;m.bToCreateShipHU=p.bToCreateShipHU===false?false:true;m.bToSelectProductInSource=p.bToSelectProductInSource===true?true:false;m.bToUpdateShipItemStatus=p.bToUpdateShipItemStatus===true?true:false;if(!m.bToSelectProductInSource){G.setSelectedProductInSource("");}},s,"disable ui interaction").then(function(){this.updateInputWithDefault(C.ID.SOURCE_INPUT,"");this.updateInputWithDefault(C.ID.PRODUCT_INPUT,"");},s).then(function(p,m){if(!m.bReferenceNumberValidated){return S.verifySource(m.sInput);}},s,"verify reference number based on bReferenceNumberValidated flag: if it is triggered by unpack/unpackAll action do not need to verify").then(function(r,m){if(!m.bReferenceNumberValidated&&r.Closed){throw new a(C.ERRORS.SHIP_HU_ALREADY_CLOSED);}if(!m.bReferenceNumberValidated){G.setSourceId(r.SourceId);G.setSourceType(r.SourceType);G.setSourceMaterialId(r.PackagingMaterial);G.setIsPickHUInSourceSide(r.IsPickHU);m.sInput=r.SourceId;}},o,"set gloable model").then(function(p,m){if(G.isShipHandlingUnitExist(m.sInput)){if(O.isShipHUClosed(m.sInput)){throw new a(C.ERRORS.SHIP_HU_ALREADY_CLOSED);}return this.getHandlingUnitDisplayWhenScanOnOtherSide();}},o,"if the user scans the ship hu, determine how to display it").then(function(p,m){if(G.isShipHandlingUnitExist(m.sInput)){if(m.sInput===G.getCurrentShipHandlingUnit()){var d={"bCallService":false,"bRefreshSource":false};this.getWorkFlowFactory().getShipHUDeleteWorkFlow().run(d);}else{c.clearShipHU(m.sInput);this.removeTabByTabName(m.sInput);G.removeShipHandlingUnit(m.sInput);}}},o,"remove ship hu if need").then(function(){this.setBusy(true);this.unbindProductInfo();this.unbindImage();this.oItemHelper.clear();G.setProductId("");},s,"clear the info of previouse source hu/bin").then(function(){this.updateInputWithDefault(C.ID.SHIP_INPUT,"");},o,"clear the ship input").then(function(){if(U.isEmpty(G.getCurrentShipHandlingUnit())){I.clear();}},s,"clear ItemWeight").then(function(p,d){this.clearPackingInstr();},o,"update packing info").then(function(){return S.getHUItems(G.getSourceId());},s,"request the HU/Bin items").then(function(i,m){this.oItemHelper.setItems(i);if(i.length!==0){this.bindODOInfo();if(!P.isInternalMode()){this.oItemHelper.setItemsStatusByConsGrp();}m.consolidationGroup=i[0].EWMConsolidationGroup;}else{if(G.getSourceType()===C.SOURCE_TYPE_ODO){throw new a(C.ERRORS.NO_UNPACKED_ITEM_FOR_ODO);}}m.aItem=i;},s,"update items info to helper method").then(function(){this.handlePackAllEnable();},s,"enable pack all if the items of source/ship hu belongs to same consolidation group").then(function(f,m){G.setExceptionEnable(false);},s,"disable exception buttons").then(function(p,m){this.setBusy(false);this.dehilightShipHandlingUnits();this.updateInputWithDefault(C.ID.SHIP_INPUT,"");},o,"highlight tab if possible").then(function(p,m){if(!this.oItemHelper.isEmpty()&&!O.isShipHUClosed()){G.setUnpackEnable(true);}if(m.bToUpdateShipItemStatus){this.updateShipItemStatus();}},o,"highlight unpack/unpackAll button and hight light first item").then(function(p,m){if(m.bToCreateShipHU&&m.aItem.length!==0&&this.needAutoCreateShippingHU(m.consolidationGroup)){this.onOpenCreateShipHUDialog();}},o,"open create shiphu dialog in need").then(function(p,m){if(!U.isEmpty(G.getCurrentShipHandlingUnit())){this.updateItemWeightInNeed();}},s,"check if there exists source item which is not in ItemWeight").then(function(){this.setBusy(false);this.focus(C.ID.PRODUCT_INPUT);},s,"enable ui interaction").then(function(p,m){this.delayCalledAdjustContainerHeight();},o).then(function(p,m){if(m.bToSelectProductInSource){var d=G.getSelectedProductInSource();if(!U.isEmpty(d)){var i=this.oItemHelper.getItemIndexByKey(d.StockItemUUID,d.Huident);if(i>=0){var e={bToAutoCreateShipHU:false,oProduct:d};this.getWorkFlowFactory().getProductChangeWorkFlow().run(e);}}}},s,"select one product in source table");w.errors().subscribe(C.ERRORS.NO_UNPACKED_ITEM_FOR_ODO,function(){var e=this.getI18nText(C.ERRORS.NO_UNPACKED_ITEM_FOR_ODO,[G.getSourceId()]);this.updateInputWithError(C.ID.SOURCE_INPUT,e);},s).subscribe(C.ERRORS.HU_NOT_EXIST,function(e){this.updateInputWithError(C.ID.SOURCE_INPUT,e);},s).subscribe(C.ERRORS.BIN_NOT_EXIST,function(){var e=this.getI18nText(C.ERRORS.BIN_NOT_EXIST);this.updateInputWithError(C.ID.SOURCE_INPUT,e);},s).subscribe(C.ERRORS.BIN_NOT_IN_PACKING_STATION,function(){var e=this.getI18nText(C.ERRORS.BIN_NOT_EXIST);this.updateInputWithError(C.ID.SOURCE_INPUT,e);},s).subscribe(C.ERRORS.SOURCE_NO_ITEM,function(){var e=this.getTextAccordingToMode("sourceWithoutItem","sourceNoItem",[G.getSourceId()]);this.updateInputWithError(C.ID.SOURCE_INPUT,e);},s).subscribe(C.ERRORS.HU_NOT_IN_WORK_CENTER,function(e){this.updateInputWithError(C.ID.SOURCE_INPUT,e);},s).subscribe(C.ERRORS.STORAGE_BIN_NOT_IN_WAREHOUSE,function(e){this.updateInputWithError(C.ID.SOURCE_INPUT,e);},s).subscribe(C.ERRORS.HU_OR_BIN_NOT_IN_WAREHOUSE,function(e){this.updateInputWithError(C.ID.SOURCE_INPUT,e);},s).subscribe(C.ERRORS.NO_PACKAGING_MATERIAL_SELECTED,function(e){this.showErrorMessagePopup(e);},s).subscribe(C.ERRORS.NO_AUTHORIZATION_FOR_WAREHOUSE,function(e){this.showToLeaveMessagePopup(e);},s).subscribe(C.ERRORS.SHIP_HU_ALREADY_CLOSED,function(e,p,m){var E=this.getTextAccordingToMode("HUClosedMsg","shipHUClosedMsg",[m.sInput]);this.updateInputWithError(C.ID.SOURCE_INPUT,E);},s).default(function(){this.updateInputWithError(C.ID.SOURCE_INPUT);},s).always(function(){this.setBusy(false);this.focus(C.ID.SOURCE_INPUT);G.setSourceId("");this.oItemHelper.setItems([]);this.unbindODOInfo();this.unbindProductInfo();this.unbindImage();this.disableButtons();this.playAudio(C.ERROR);},s).always(function(){G.setUnpackEnable(false);if(!this.oItemHelper.isEmpty()){this.oItemHelper.setItemsStatusToNone();}},o);return w;};});
