/*
 * Copyright (C) 2009-2023 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["scm/ewm/packoutbdlvs1/workflows/WorkFlow","scm/ewm/packoutbdlvs1/utils/Util","scm/ewm/packoutbdlvs1/utils/Const","scm/ewm/packoutbdlvs1/modelHelper/Global","scm/ewm/packoutbdlvs1/modelHelper/Cache","scm/ewm/packoutbdlvs1/utils/CustomError","scm/ewm/packoutbdlvs1/modelHelper/PackingMode","scm/ewm/packoutbdlvs1/modelHelper/Message"],function(W,U,C,G,a,b,P,M){"use strict";return function(s,S){var w=new W().then(function(p,m){G.setSelectedProductInSource("");m.bToAutoCreateShipHU=true;if(!U.isEmpty(p.bToAutoCreateShipHU)){m.bToAutoCreateShipHU=p.bToAutoCreateShipHU;p=p.oProduct;}m.bInputByScan=U.isString(p);return this.getItemIndexByProductOrEAN(p,m);},s).then(function(p,m){this.prepareDataForProductChangeWorkFlow(m);},s).then(function(p,m){m.bStockLevelSnDialogOpened=false;if(m.bInputByScan&&this.oItemHelper.isStockLevelSnEnabledByIndex(m.iItemIndex)){if(this.oItemHelper.getItemCountByProduct(m.sProduct)>1){m.bStockLevelSnDialogOpened=true;var d=this.getStockLevelSnDialog(m.sProduct);return this.openDialog(d);}}},s).then(function(i,m){if(m.bStockLevelSnDialogOpened){m.iItemIndex=i;}},s).then(function(p,m){m.bBatchDialogOpened=false;if(m.bInputByScan&&!m.bStockLevelSnDialogOpened&&this.oItemHelper.hasMutlipleBatchesByProduct(m.sProduct)){m.bBatchDialogOpened=true;var d=this.getBatchNumberDialog(m.sProduct);return this.openDialog(d);}},s).then(function(B,m){if(m.bBatchDialogOpened){m.iItemIndex=this.oItemHelper.getItemIndexByProductAndBatch(m.sProduct,B);if(!U.isEmpty(m.sShipConsGroup)){var i=this.oItemHelper.getItemIndexByProductActiveConsGroupAndBatch(m.oProduct,m.sShipConsGroup,B);if(i!==-1){m.iItemIndex=i;}}}},s).then(function(p,m){if(!m.bBatchDialogOpened&&!m.bStockLevelSnDialogOpened){if(!U.isEmpty(m.sShipConsGroup)){var i=this.oItemHelper.getItemIndexByProductAndActiveConsGroup(m.sProduct,m.sShipConsGroup);if(i!==-1){m.iItemIndex=i;}}}},s).then(function(p,m){var c=this.oItemHelper.getItemStockIdByIndex(m.iItemIndex);this.oItemHelper.sortItemsByKey(c,m.oProduct.Huident);},s).then(function(p,m){m.consolidationGroup=this.oItemHelper.getFirstItemConsGroup();},s).then(function(p,m){if(this.oItemHelper.isReductionFirstItem()){var d=this.getChangePackQuantityDialog(m.sProduct);return this.openDialog(d);}},s).then(function(){this.bindProductInfo();this.bindImage();this.bindODOInfo();this.updateInputWithDefault(C.ID.PRODUCT_INPUT,"");this.focus(C.ID.PRODUCT_INPUT);this.oItemHelper.setItemsStatusByConsGrp();this.handleExceptionEnable();this.updateSourceItemStatus();},s).then(function(p,m){this.updateInputWithDefault(C.ID.SHIP_INPUT,"");this.dehilightShipHandlingUnits();var h=this.getHightlightShipHandlingUnits(m.consolidationGroup);if(h.length>0){this.hilightShipHandlingUnits(h);}},S,"highlight ship handling unit if possible").then(function(p,m){if(m.bToAutoCreateShipHU&&this.needAutoCreateShippingHU(m.consolidationGroup)){this.onOpenCreateShipHUDialog();}},S,"open create ship hu dialog in need").then(function(p,m){if(!P.isInternalMode()&&U.isEmpty(m.consolidationGroup)&&G.getCheckConsolidationGroup()){var c=this.getI18nText("packItemWithNoConGrp");M.addWarning(c);}},S,"add warning message for broken items").then(function(p,o){o.sODO="";o.sPackInstr="";if(this.oItemHelper.getHighLightedItemIndex()===0){o.sODO=this.oItemHelper.getItemDocNoByIndex(0);o.sPackInstr=this.oItemHelper.getItemPackInstrByIndex(0);}},s).then(function(p,o){this.updatePackingInstr(o.sODO,o.sPackInstr);},S,"update packing info").then(function(p,o){this.updatePackingInstr(o.sODO,o.sPackInstr);},S,"update packing info").then(function(p,m){G.setSelectedProductInSource(this.oItemHelper.getItemByIndex(0));},s);w.errors().subscribe(C.ERRORS.PRODUCT_NOT_IN_SOURCE,function(e,p,m){var E;if(G.getSourceId()){E=this.getTextAccordingToMode("productNotInSource","productNotInReference",[m.sProduct,G.getSourceId()]);}else{E=this.getTextAccordingToMode("provideHUFirst","provideReferenceFirst");}this.updateInputWithError(C.ID.PRODUCT_INPUT,E);},s).subscribe(C.ERRORS.PRODUCT_WITH_DIFF_CONS_GROUP,function(){var m=this.getTextAccordingToMode("differentConsGroupWithHUMsg","differentConsGroupWithShipHUMsg");this.updateInputWithError(C.ID.PRODUCT_INPUT,m);},s).default(function(e){this.updateInputWithError(C.ID.PRODUCT_INPUT,e);},s).always(function(){this.focus(C.ID.PRODUCT_INPUT);G.setProductId("");this.unbindProductInfo();this.unbindODOInfo();this.unbindImage();G.setExceptionEnable(false);if(!this.oItemHelper.isEmpty()){this.oItemHelper.setItemsStatusByConsGrp();}this.playAudio(C.ERROR);},s).always(function(){this.clearPackingInstr();},S);return w;};});
