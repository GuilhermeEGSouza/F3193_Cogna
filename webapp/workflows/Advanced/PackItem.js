/*
 * Copyright (C) 2009-2023 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["scm/ewm/packoutbdlvs1/workflows/MixedWorkFlow","scm/ewm/packoutbdlvs1/utils/Util","scm/ewm/packoutbdlvs1/utils/Const","scm/ewm/packoutbdlvs1/modelHelper/Message","scm/ewm/packoutbdlvs1/modelHelper/Global","scm/ewm/packoutbdlvs1/modelHelper/SerialNumber","scm/ewm/packoutbdlvs1/service/ODataService","scm/ewm/packoutbdlvs1/modelHelper/Cache"],function(W,U,C,M,G,S,a,b){"use strict";return function(s,o){var w=new W().then(function(p,m){m.sAlterQuan=JSON.parse(JSON.stringify(p.oProduct.AlterQuan));m.sBaseQuan=JSON.parse(JSON.stringify(p.oProduct.Quan));m.oProduct=JSON.parse(JSON.stringify(p.oProduct));m.oPackProduct=p.oProduct;m.SnList=m.oProduct.SnList;m.IuidList=m.oProduct.IuidList;},s,"disable ui interaction").then(function(p,m){if(!U.isEmpty(m.oProduct.SerialNumberRequiredLevel)&&m.oProduct.SerialNumberRequiredLevel!==C.SN_DOC_LEVEL_PROFILE_D){if(!(m.oProduct.SerialNumberRequiredLevel===C.SN_DOC_LEVEL_PROFILE_A&&m.oProduct.EWMDeliveryDocumentCategory!==C.DOCUMENT_CAT_OUTBOUND)){if(!(this.oItemHelper.getItemCountByProduct(m.oProduct.ProductName)===1&&m.oProduct.SerialNumberRequiredLevel===C.SERIAL_NUMBER_STOCK_LEVEL)){if(this.oItemHelper.isReductionFirstItem()){var r=this.oItemHelper.getAlternativeUOMRatio(m.oProduct);var R=U.parseNumber(this.oItemHelper.getItemReductionQtyByIndex(0));m.oPackProduct.QuanDefault=m.oProduct.Quan;var B=(R*r).toString();this.oItemHelper.setItemReductBaseQuanByIndex(0,B);}var d=this.getSerialNumberDialog();m.bManualAssignSn=true;return this.openDialog(d);}}}},s,"open serial number dialog in need").then(function(p,m){m.oProduct.AlterQuan=this.oItemHelper.getItemReductionQtyByIndex(0);},s,"set product packing quantity").then(function(p,m){if(!U.isEmpty(m.oProduct.SerialNumberRequiredLevel)&&m.bManualAssignSn===true){var P=S.convertSerialNumbersToString();if(m.oProduct.isIuidActive===C.ABAP_TRUE){m.oProduct.IuidList=S.getPackedUiis(m.oProduct.SnList.split(" "),m.oProduct.IuidList.split(" "),P.split(" "));}if(!U.isEmpty(P)){m.oProduct.SnList=P;}}},s,"get user input serial numbers").then(function(){return this.updateItemWeightInNeed();},s,"check if there exists source item which is not in ItemWeight").then(function(p,m){if(U.parseNumber(m.oProduct.QtyReduced)!==0){m.fPackQuantity=U.parseNumber(m.oProduct.AlterQuan);}},s,"check order reduction case").service(function(p,m){m.newSnList=m.oProduct.SnList;m.newIuidList=m.oProduct.IuidList;m.actualPackQuantity=m.oProduct.AlterQuan;this.setBusy(true);return a.pack(m.oProduct,m.fPackQuantity);},s,"pack item").then(function(p,m){if(!G.getAsyncMode()){m.NetWeight=p.NetWeight;m.WeightUoM=p.WeightUoM;}m.sStockItemUUID=p?p.StockItemUUID:"";if(!U.isEmpty(p)){m.oProduct=this.getNewItemWithPartialQuantity(m.oProduct,p);}this.setBusy(false);this.oItemHelper.deleteItem(m.oPackProduct);G.setProductId("");G.setExceptionEnable(false);},s,"remove item from the source table").then(function(){this.unbindProductInfo();this.unbindImage();},s,"unbind product info").then(function(){this.unbindODOInfo();this.focus(C.ID.PRODUCT_INPUT);if(!this.oItemHelper.isEmpty()){this.oItemHelper.setItemsStatusByConsGrp();this.bindODOInfo();}},s,"update odo info").then(function(p,m){if((m.oProduct.SerialNumberRequiredLevel===C.SN_DOC_LEVEL_PROFILE_A&&m.oProduct.EWMDeliveryDocumentCategory===C.DOCUMENT_CAT_OUTBOUND)||m.oProduct.SerialNumberRequiredLevel===C.SN_DOC_LEVEL_PROFILE_B){this.oItemHelper.removeSerialNumberFromOtherItems(m.oProduct.ProductName,S.getAllSerialNumerKeys());}},s,"remove serial number from other items").then(function(p,m){this.updateInputWithDefault(C.ID.SHIP_INPUT,"");m.bShipHUEmptyBeforePack=this.oItemHelper.isEmpty();},o).syncOnly(function(p,m){if(U.parseNumber(m.oProduct.AlterQuan)!==0){this.oItemHelper.updateItem(m.oProduct);}},o,"add item in the ship table").asyncOnly(function(p,m){if(U.parseNumber(m.oProduct.AlterQuan)!==0){if(U.isAbapTrue(m.oProduct.isSplit)){this.oItemHelper.addItemWithoutMerge(m.oProduct);}else{var c=this.oItemHelper.getItemStockIdByOriginalId(m.oProduct.StockItemUUID);m.oProduct=this.oItemHelper.updateItemStockId(m.oProduct,c);this.oItemHelper.addItem(m.oProduct,true);}}},o,"add item in the ship table").then(function(p,m){if(U.parseNumber(m.oProduct.QtyReduced)!==0){this.oItemHelper.setItemQtyReducedInitialized();}},o).then(function(p,m){if(!G.getAsyncMode()){this.updateNetWeightRelated(m.NetWeight,m.WeightUoM);this.clearGrossWeight();}},o,"update weight chart, color and text").asyncOnly(function(p,m){this.oItemHelper.updateHighlightStatus(m.oProduct,sap.ui.core.MessageType.None);this.oItemHelper.updatePendingStatus(m.oProduct,true);this.handleUnpackEnable();},o).then(function(){this.dehilightShipHandlingUnits();},o).then(function(p,m){if(m.bShipHUEmptyBeforePack){b.updateShipHUConsGroup(G.getCurrentShipHandlingUnit(),m.oProduct.EWMConsolidationGroup);}this.setBusy(false);},o,"update the status of the first item in the ship table ").syncOnly(function(){this.oItemHelper.setItemsStatusToNone();this.oItemHelper.setItemHighlightByIndex(0);this.handleUnpackEnable();},o).serviceCallback(function(p,m){m.NetWeight=p.NetWeight;m.WeightUoM=p.WeightUoM;this.updateNetWeightRelated(m.NetWeight,m.WeightUoM);this.clearGrossWeight();m.sStockItemUUID=p.StockItemUUID;this.oItemHelper.updateItemStockIdByKey(m.oProduct.StockItemUUID,m.sStockItemUUID,m.oProduct.Huident);this.oItemHelper.setItemsStatusToNone();this.oItemHelper.updateHighlightStatus(m.oProduct,sap.ui.core.MessageType.Success);this.oItemHelper.updatePendingStatus(m.oProduct,false);w.getAsyncPromise().then(function(){this.handleUnpackEnable();}.bind(this)).then(function(){this.handlePackAllEnable();}.bind(s));},o).then(function(p,P){this.clearPackingInstr();},o,"update packing info").then(function(p,P){this.updateCacheIsEmptyHU();},o,"update cache").syncOnly(function(p,m){this.handlePackAllEnable();},s,"handle pack all enable").then(function(p,m){this.delayCalledAdjustContainerHeight();},o);w.errors().default(function(e,p,m,c){if(c){this.showErrorMessagePopup(e);}},s).always(function(e,p,m){if(G.getAsyncMode()){var c=this.oItemHelper.getItemByKey(m.oProduct.StockItemUUID,m.oProduct.Huident);m.oUnpackItem=JSON.parse(JSON.stringify(c));if(c.AlterQuan===m.actualPackQuantity){this.oItemHelper.deleteItem(c);}else{this.oItemHelper.updateItemQuantity(c,m.sAlterQuan,true);this.oItemHelper.updatePendingStatus(m.oProduct,false);this.oItemHelper.setItemsStatusToNone();this.oItemHelper.updateHighlightStatus(m.oProduct,sap.ui.core.MessageType.Success);m.oUnpackItem.AlterQuan=m.sAlterQuan;if(!U.isEmpty(m.oProduct.SerialNumberRequiredLevel)){var d=this.oItemHelper.parseSerialNumber(m.newSnList);this.oItemHelper.removeSerialNumberFromItem(d,c);if(m.oProduct.isIuidActive===C.ABAP_TRUE){this.oItemHelper.removeIuidFromItem(c,m.newIuidList);}}}var l=this.getLoadingWeightInCurrentShipHandlingUnit();var u=this.getWeightUOMInCurrentShipHandlingUnit();this.updateNetWeightRelated(l,u);if(!U.isEmpty(m.oProduct.SerialNumberRequiredLevel)){m.oUnpackItem.SnList=m.SnList;m.oUnpackItem.IuidList=m.IuidList;}this.handleUnpackEnable();G.setExceptionEnable(true);}},o).always(function(e,p,m){if(G.getAsyncMode()){this.oItemHelper.addItem(m.oUnpackItem);this.oItemHelper.setItemsStatusByConsGrp();this.oItemHelper.setItemHighlightByIndex(0);this.handlePackAllEnable();}else{m.oPackProduct.AlterQuan=m.sAlterQuan;m.oPackProduct.Quan=m.sBaseQuan;}this.setBusy(false);this.focus(C.ID.PRODUCT_INPUT);this.playAudio(C.ERROR);},s);return w;};});
