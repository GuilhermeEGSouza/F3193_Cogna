/*
 * Copyright (C) 2009-2023 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["scm/ewm/packoutbdlvs1/workflows/WorkFlow","scm/ewm/packoutbdlvs1/service/ODataService","scm/ewm/packoutbdlvs1/modelHelper/Global","scm/ewm/packoutbdlvs1/modelHelper/SerialNumber","scm/ewm/packoutbdlvs1/modelHelper/Cache","scm/ewm/packoutbdlvs1/utils/Util","scm/ewm/packoutbdlvs1/utils/Const","scm/ewm/packoutbdlvs1/modelHelper/Message"],function(W,S,G,a,C,U,b,M){"use strict";return function(s,o){var w=new W().then(function(p,m){m.iQuantity=p.iQuantity;m.oDialog=p.oDialog;m.oProduct=p.oProduct;m.sUoM=p.sUoM;m.sStockItemUUID=p.oProduct.StockItemUUID;if(!U.isEmpty(m.oProduct.SerialNumberRequiredLevel)){var P=a.convertSerialNumbersToString();if(m.oProduct.isIuidActive===b.ABAP_TRUE){m.oProduct.IuidList=a.getPackedUiis(m.oProduct.SnList.split(" "),m.oProduct.IuidList.split(" "),P.split(" "));}m.oProduct.SnList=P;}},s,"set mSesssion").then(function(){return this.updateItemWeightInNeed();},s,"check if there exists source item which is not in ItemWeight").then(function(p,m){return S.pack(m.oProduct,m.iQuantity,m.sUoM);},s).then(function(p,m){m.NetWeight=p.NetWeight;m.WeightUoM=p.WeightUoM;m.oUpdateInfo=p;return S.getHUItems(G.getSourceId());},s,"get source hu items").then(function(p,m){m.oDialog.setBusy(false);this.closeDialog(m.oDialog);var c=U.find(p,function(i){if(i.StockItemUUID===m.sStockItemUUID){return true;}return false;});this.oItemHelper.updateItemQuantityByIndex(0,U.parseNumber(c.AlterQuan),U.parseNumber(c.Quan));this.oItemHelper.updateItemWeightByIndex(0,U.parseNumber(c.NetWeight),c.WeightUoM);this.oItemHelper.updateItemVolumeByIndex(0,U.parseNumber(c.Volume),c.VolumeUoM);m.oProduct=this.getNewItemWithPartialQuantity(m.oProduct,m.oUpdateInfo);this.focus(b.ID.PRODUCT_INPUT);},s).then(function(p,m){if(this.oItemHelper.isStockLevelSerialNumber()){var c=this.oItemHelper.getSerialNumberListByIndex(0);this.oItemHelper.removeSerialNumberFromCurrentItem(a.getAllSerialNumerKeys());if(m.oProduct.isIuidActive===b.ABAP_TRUE){this.oItemHelper.removeSerialNumberUiiFromCurrentItem(c,a.getAllSerialNumerKeys());}}else{if(this.oItemHelper.isSerialNumbersAllInSnListByIndex(0,a.getAllSerialNumerKeys())){this.oItemHelper.removeSerialNumberFromCurrentItem(a.getAllSerialNumerKeys());}else{this.oItemHelper.clearSnListByIndex(0);this.oItemHelper.removeSerialNumberFromOtherItems(m.oProduct.ProductName,a.getAllSerialNumerKeys());}}},s).then(function(p,m){this.updateInputWithDefault(b.ID.SHIP_INPUT,"");m.bShipHUEmptyBeforePack=this.oItemHelper.isEmpty();this.oItemHelper.updateItem(m.oProduct);this.oItemHelper.setItemsStatusToNone();this.oItemHelper.setItemHighlightByIndex(0);this.handleUnpackEnable();},o).then(function(p,m){this.updateNetWeightRelated(m.NetWeight,m.WeightUoM);this.clearGrossWeight();},o,"update weight chart, color and text").then(function(){this.dehilightShipHandlingUnits();},o).then(function(p,m){if(m.bShipHUEmptyBeforePack){C.updateShipHUConsGroup(G.getCurrentShipHandlingUnit(),m.oProduct.EWMConsolidationGroup);}},o).then(function(p,P){P.sODO=this.oItemHelper.getItemDocNoByIndex(0);P.sPackInstr=this.oItemHelper.getItemPackInstrByIndex(0);},s).then(function(p,P){this.updatePackingInstr(P.sODO,P.sPackInstr);},o,"update packing info").then(function(p,P){this.updateCacheIsEmptyHU();},o,"update cache").then(function(p,m){this.delayCalledAdjustContainerHeight();},o);w.errors().default(function(e,p,m,c){if(c){this.showErrorMessagePopup(e);}},s).always(function(e,p,m){m.oDialog.setBusy(false);this.closeDialog(m.oDialog);this.focus(b.ID.PRODUCT_INPUT);this.playAudio(b.ERROR);if(!U.isEmpty(G.getSourceId())){G.setExceptionEnable(false);S.getHUItems(G.getSourceId()).then(function(i){if(i[0]){this.oItemHelper.setItems(i);this.oItemHelper.sortItemsByKey(m.oProduct.StockItemUUID,m.oProduct.Huident);this.bindODOInfo();this.oItemHelper.setItemsStatusByConsGrp();}}.bind(this)).catch(function(E){});}},s);return w;};});
