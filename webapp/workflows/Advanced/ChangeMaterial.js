/*
 * Copyright (C) 2009-2023 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["scm/ewm/packoutbdlvs1/workflows/WorkFlow","scm/ewm/packoutbdlvs1/service/ODataService","scm/ewm/packoutbdlvs1/modelHelper/Global","scm/ewm/packoutbdlvs1/utils/Util","scm/ewm/packoutbdlvs1/utils/Const","scm/ewm/packoutbdlvs1/modelHelper/Message","scm/ewm/packoutbdlvs1/modelHelper/Cache","scm/ewm/packoutbdlvs1/modelHelper/Material"],function(W,S,G,U,C,M,a,b){"use strict";return function(s,o){var w=new W().then(function(c,m){m.oDialog=c.oDialog;m.bMaterialChanged=c.bMaterialChanged;return S.changeMaterial(c.sHuId);},o).then(function(p,m){m.NetWeight=p.NetWeight;m.WeightUoM=p.WeightUoM;m.sHuId=p.HuId;m.sGrossWeight=this.getGrossWeight();var n=p.HuId;m.sOldShippingId=G.getCurrentShipHandlingUnit();G.changeShipHandlingUnit(m.sOldShippingId,n);this.setCurrentShipHandlingUnit(n);},o).then(function(p,m){return this.recreateTab(m.sOldShippingId,m.sHuId);},o).then(function(p,m){this.updateCurrentMaterialAfterChange();S.getHUSet(m.sHuId,C.SHIP_TYPE_HU);this.setGrossWeight(m.sGrossWeight);},o).then(function(p,m){this.setBusy(true);return S.getHUItems(m.sHuId,C.SHIP_TYPE_HU);},o,"get hu items").then(function(p,m){this.setBusy(false);this.oItemHelper.setItems(p);this.updateShipItemStatus();},o,"reset ship item status").then(function(p,m){return this.updateItemWeightInNeed(m.sHuId,C.SHIP_TYPE_HU);},o,"check if there exists ship item which is not in ItemWeight").then(function(p,P){var l=this.getLoadingWeightInCurrentShipHandlingUnit();var u=this.getWeightUOMInCurrentShipHandlingUnit();this.updateNetWeightRelated(l,u);if(P.bMaterialChanged){this.clearGrossWeight();}},o,"update weight chart, color and text").then(function(p,P){P.sODO="";P.sPackInstr="";if(this.oItemHelper.getHighLightedItemIndex()===0){P.sODO=this.oItemHelper.getItemDocNoByIndex(0);P.sPackInstr=this.oItemHelper.getItemPackInstrByIndex(0);}},s).then(function(p,P){this.updatePackingInstr(P.sODO,P.sPackInstr);},o,"update packing info").then(function(p,P){this.updateCacheIsEmptyHU();},o,"update cache").then(function(p,m){m.oDialog.setBusy(false).close();}).then(function(p,m){var c=this.getTextAccordingToMode("changeHUMaterialSuccessfulMsg","changeShipHUMaterialSuccessfulMsg",[m.sHuId]);M.addSuccess(c);this.playAudio(C.INFO);},o);w.errors().subscribe(C.ERRORS.CREATE_HU_DUPLICATE,function(e){this.updateInputWithError(C.ID.CHANGE_SHIP_INPUT,e);this.focus(C.ID.CHANGE_SHIP_INPUT);},o).subscribe(C.ERRORS.CHANGE_ID_DUPLICATE,function(e){this.updateInputWithError(C.ID.CHANGE_SHIP_INPUT,e);this.focus(C.ID.CHANGE_SHIP_INPUT);},o).subscribe(C.ERRORS.HU_ASSIGNED_FAILED,function(e){this.updateInputWithError(C.ID.CHANGE_SHIP_INPUT,e);this.focus(C.ID.CHANGE_SHIP_INPUT);},o).subscribe(C.ERRORS.CHANGE_MATERIAL_EXCEED_MAX,function(e){this.byId(C.ID.ERROR_MATERIAL_STRIP).setText(e);this.setMessageStripVisible(C.ID.ERROR_MATERIAL_STRIP,true);},o).subscribe(C.ERRORS.INITIAL_CAN_NOT_READ_HUS,function(e){this.byId(C.ID.ERROR_MATERIAL_STRIP).setText(e);this.setMessageStripVisible(C.ID.ERROR_MATERIAL_STRIP,true);},o).default(function(e){this.getView().byId("change-material-dialog").close();},o).default(function(e,p,m,c){if(c){this.showErrorMessagePopup(e);}},s).always(function(e,p,m){this.getView().byId("change-material-dialog").setBusy(false);this.clearGrossWeight();if(U.isEmpty(p.PackagingMaterial)){b.setCurrentMaterial({});}else{var c=b.getMaterialById(p.PackagingMaterial);b.setCurrentMaterial(c);}if(!U.isEmpty(p.HuId)){var d=G.getCurrentShipHandlingUnit();if(d!==p.HuId){this.recreateTab(d,p.HuId).then(function(){G.setCurrentShipHandlingUnit(p.HuId);G.changeShipHandlingUnit(d,p.HuId);});}S.getHUItems(p.HuId,C.SHIP_TYPE_HU).then(function(i){this.oItemHelper.setItems(i);if(i.length!==0){a.updateShipHUConsGroup(p.HuId,i[0].EWMConsolidationGroup);this.updateShipItemStatus();}else{a.updateShipHUConsGroup(p.HuId,"");}this.updateCacheIsEmptyHU();this.updateItemWeightInNeed(p.HuId,C.SHIP_TYPE_HU).then(function(){var l=this.getLoadingWeightInCurrentShipHandlingUnit();var u=this.getWeightUOMInCurrentShipHandlingUnit();this.updateNetWeightRelated(l,u);}.bind(this));}.bind(this)).catch(function(E){});}this.playAudio(C.ERROR);},o);return w;};});
